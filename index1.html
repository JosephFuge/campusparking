<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Provo Parking Solution</title>
    <!-- Linking an external stylesheet -->
    <link rel="stylesheet" href="styles.css">
</head>

<body>

    <div id="map-container">
        <!-- The map will be displayed here -->
        <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDYKlll1uqfnRYvQ0AP5zNWRIpMJyIdayo&callback=initMap&libraries=maps,marker&v=beta"></script>
        <script>
            var map;
            var infoWindow;
            var markers = []; // Array to store markers

            function initMap() {
                map = new google.maps.Map(document.getElementById('map-container'), {
                    center: { lat: 40.233943939208984, lng: -111.65744018554688 },
                    zoom: 14
                });
                infoWindow = new google.maps.InfoWindow();
            }

            function geocodeAddress(address, buyNowButton) {
                var geocoder = new google.maps.Geocoder();

                geocoder.geocode({ 'address': address }, function (results, status) {
                    if (status === 'OK') {
                        map.setCenter(results[0].geometry.location);

                        // Place a marker on the map
                        var marker = new google.maps.Marker({
                            map: map,
                            position: results[0].geometry.location,
                            title: address
                        });

                        // Info window content
                        var rate = document.getElementById('rate');
                        var name = document.getElementById('name');
                        var infoContent = `<div><strong>${name.value}</strong><br>Address: ${address}<br>Rate: ${rate.value}</div>`;

                        marker.addListener('click', function () {
                            infoWindow.setContent(infoContent);
                            infoWindow.open(map, marker);
                        });

                        // Store the marker in the array
                        markers.push(marker);

                        // Clear the form fields
                        document.getElementById("address").value = "";
                        document.getElementById("rate").value = "";
                        document.getElementById("name").value = "";

                        // Add a reference to the marker in the Buy Now button
                        buyNowButton.marker = marker;
                    } else {
                        alert('Geocode was not successful for the following reason: ' + status);

                        document.getElementById("address").value = "";
                        document.getElementById("rate").value = "";
                        document.getElementById("name").value = "";
                    }
                });
            }

            function removeMarker(buyNowButton) {
                // Remove the marker associated with the clicked Buy Now button
                var markerToRemove = buyNowButton.marker;
                if (markerToRemove) {
                    markerToRemove.setMap(null); // Remove the marker from the map
                    // Remove the marker from the array
                    markers = markers.filter(marker => marker !== markerToRemove);
                }
            }

            function addParkingSpot() {
                var address = document.getElementById("address").value;
                var rate = document.getElementById("rate").value;
                var name = document.getElementById("name").value;

                // Create a new parking spot listing
                var newSpot = document.createElement("div");
                newSpot.className = "parking-spot";
                newSpot.innerHTML = `<strong>${name}</strong><br>Address: ${address}<br>Rate: ${rate}`;

                // Add "Buy Now" button to the new parking spot listing
                var buyNowButton = document.createElement("button");
                buyNowButton.className = "buy-now-button";
                buyNowButton.textContent = "Buy Now";
                buyNowButton.addEventListener("click", function () {
                    // Remove the parking spot listing from the feed
                    var parkingFeed = document.getElementById("parking-feed");
                    parkingFeed.removeChild(newSpot);

                    // Remove the associated marker from the map
                    removeMarker(buyNowButton);

                    alert(`You have purchased the parking spot at ${address} for ${rate}. Thank you!`);
                });

                // Create a container for the Buy Now button
                var buttonContainer = document.createElement("div");
                buttonContainer.appendChild(buyNowButton);

                // Append the Buy Now button container to the parking spot listing
                newSpot.appendChild(buttonContainer);

                // Add the new spot to the feed
                var parkingFeed = document.getElementById("parking-feed");
                parkingFeed.insertBefore(newSpot, parkingFeed.firstChild);

                // Call the geocodeAddress function to place a marker on the map
                geocodeAddress(address, buyNowButton);
            }
        </script>
    </div>

    <div id="feed-container">
        <div id="input-form">
            <h2>Add Your Parking Spot</h2>
            <form id="parking-form">
                <label for="address">Address:</label>
                <input type="text" id="address" name="address" required><br>
                <label for="rate">Price/Time of Availability:</label>
                <input type="text" id="rate" name="rate" required><br>
                <label for="name">Your Name:</label>
                <input type="text" id="name" name="name" required><br>
                <button type="button" onclick="addParkingSpot()">Add Parking Spot</button>
            </form>
        </div>

        <h2>Parking Feed</h2><br>

        <div id="parking-feed">
            <!-- Parking spot listings will be displayed here -->
        </div>
    </div>

</body>

</html>
